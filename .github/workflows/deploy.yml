name: Publication site

on:
  workflow_run:
    workflows: ["CI - Vérification HTML"]
    branches: ["main"]
    types: [completed]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: [self-hosted, linux, x64]

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout du commit validé par la CI
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Déploiement local (nginx)
        run: |
          set -e
          sudo mkdir -p /var/www/tpcicd
          sudo rsync -av --delete \
            --exclude ".git" \
            --exclude ".github" \
            ./ /var/www/tpcicd/
          sudo chown -R www-data:www-data /var/www/tpcicd
          sudo find /var/www/tpcicd -type d -exec chmod 755 {} \;
          sudo find /var/www/tpcicd -type f -exec chmod 644 {} \;

      - name: Configurer GitHub Pages
        uses: actions/configure-pages@v5

      - name: Uploader l'artifact Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Déployer sur GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
